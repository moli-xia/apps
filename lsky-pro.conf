# --- 基础信息 / Basic Information ---
local app_id="lsky-pro" 
local app_name="Lsky Pro" 
local app_text="高性能、功能丰富的自托管图床系统(Postgres + Redis版)" 
local app_url="https://www.lsky.pro/" 
local docker_name="lsky-pro" 
local docker_port="8000" 
local app_size="1" 

# --- 核心逻辑 / Core Logic ---
docker_app_install() {
    # 1. 创建应用目录
    mkdir -p /home/docker/lsky-pro && cd /home/docker/lsky-pro

    # 2. 写入 docker-compose.yml
    # 使用 cat 写入可以避免维护外部 raw 链接的麻烦，且方便 sed 替换
    cat <<EOF > docker-compose.yml
services:
  postgres:
    image: postgres:15
    container_name: lsky-postgres
    environment:
      - POSTGRES_DB=lsky
      - POSTGRES_USER=lsky
      - POSTGRES_PASSWORD=lsky-password
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lsky -d lsky"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: lsky-redis
    command: redis-server --appendonly yes --requirepass "redis-password"
    volumes:
      - ./redis-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis-password", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  lsky-pro:
    image: 0xxb/lsky-pro:latest
    container_name: ${docker_name}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${docker_port}:8000"
    volumes:
      - ./storage:/app/storage/app
      - ./themes:/app/themes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  postgres-data:
  redis-data:
  storage:
  themes:
EOF

    # 3. 启动容器
    docker compose up -d
    echo "安装完成 / Install Complete"

    # 显示访问地址
    check_docker_app_ip
}

docker_app_update() {
    cd /home/docker/lsky-pro
    docker compose pull
    docker compose up -d
    echo "更新完成 / Update Complete"
}

docker_app_uninstall() {
    cd /home/docker/lsky-pro
    # 停止并删除容器及镜像
    docker compose down --rmi all
    # 清理物理文件
    cd ..
    rm -rf /home/docker/lsky-pro
    echo "卸载完成 / Uninstall Complete"
}

# --- 注册 (必须包含) / Registration (Mandatory) ---
# 此处通常会调用注册逻辑，保持你原有脚本结构即可
